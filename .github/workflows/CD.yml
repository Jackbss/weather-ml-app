name: CD â€“ Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      IMAGE_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/weather-ml-image
      # Use the SAME pattern as CI, but based on the CI workflow run_number
      IMAGE_TAG: v2.${{ github.event.workflow_run.run_number }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create SSH key for server
      run: |
        printf "%s" "${{ secrets.EC2_KEY }}" > key.pem
        chmod 400 key.pem

    - name: Copy manifests and Ansible to server
      run: |
        scp -o StrictHostKeyChecking=no -i key.pem -r ansible ubuntu@${{ secrets.SERVER_IP }}:~/weather-ml-app/ansible
        scp -o StrictHostKeyChecking=no -i key.pem -r k8s ubuntu@${{ secrets.SERVER_IP }}:~/weather-ml-app/k8s
        
    - name: Run Ansible Playbooks on server
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.SERVER_IP }} "
          cd ~/weather-ml-app/ansible &&
          ansible-playbook install_kubectl.yml &&
          ansible-playbook deploy_weather_app.yml \
            --extra-vars 'image=${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}' &&
          ansible-playbook deploy_scale.yml &&
          ansible-playbook rolling_update.yml \
            --extra-vars 'image=${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}'
        "
