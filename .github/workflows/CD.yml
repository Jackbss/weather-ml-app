name: CD â€“ Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create SSH key for server
      run: |
        printf "%s" "${{ secrets.EC2_KEY }}" > key.pem
        chmod 400 key.pem

    - name: Copy Ansible directory to server
      run: |
        scp -o StrictHostKeyChecking=no \
            -i key.pem -r ansible ubuntu@${{ secrets.SERVER_IP }}:~/weather-ml-app/ansible

    - name: Run Ansible Playbooks on server
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.SERVER_IP }} "
          cd ~/weather-ml-app/ansible &&
            ansible-playbook install_kubectl.yml &&
            ansible-playbook deploy_weather_app.yml \--extra-vars 'image=${{ secrets.DOCKERHUB_USERNAME }}/weather-ml-app:latest' &&
            ansible-playbook deploy_scale.yml &&
            ansible-playbook rolling_update.yml \--extra-vars 'image=${{ secrets.DOCKERHUB_USERNAME }}/weather-ml-app:latest'"
