name: CD â€“ Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI Pipeline"] 
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure access to Kubernetes
      run: |
        mkdir -p ~/.kube
        printf "%s" "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config

    - name: Create SSH key
      run: |
        printf "%s" "${{ secrets.SSH_KEY }}" > key.pem
        chmod 400 key.pem

    - name: Deploy to Production Server
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.SERVER_IP }} \
        "kubectl set image deployment/weather-app weather-ml-app=${{ secrets.DOCKERHUB_USERNAME }}/weather-ml-app:1.0 &&
         kubectl rollout status deployment/weather-app"
